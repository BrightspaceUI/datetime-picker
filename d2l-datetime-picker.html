<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../d2l-date-picker/d2l-date-picker.html">
<link rel="import" href="../d2l-time-picker/d2l-time-picker.html">
<link rel="import" href="../d2l-offscreen/d2l-offscreen.html">
<link rel="import" href="localize-behavior.html">
<script type="text/javascript" src="https://s.brightspace.com/lib/d2l-intl/0.2.1/Intl.js"></script>

<!--
`d2l-time-picker`
Accessible, Localized Time Picker Input Element

@demo demo/index.html
-->

<dom-module id="d2l-datetime-picker">
	<template strip-whitespace>
		<style include="d2l-offscreen-shared-styles">
			:host {
				display: inline-flex;
				align-items: flex-start;
			}

			label {
				@apply --d2l-offscreen;
			}

			d2l-date-picker {
				padding-right: 1rem;
				--paper-input-container: {
					padding: 0;
				};
			}
		</style>
		<label for="input">{{_dateLabel}}</label>
		<d2l-date-picker value="[[_dateValue]]"></d2l-date-picker>
		<d2l-time-picker
			label="[[_timeLabel]]"
			locale="[[locale]]"
			overrides="[[overrides]]"
			timezone="[[timezone]]"
			hours="{{hours}}"
			minutes="{{minutes}}"
			boundary="[[boundary]]"
		></d2l-time-picker>
	</template>

	<script>
		Polymer({
			is: 'd2l-datetime-picker',

			listeners: {
				'd2l-date-picker-value-changed': '_dateChanged',
				'd2l-time-picker-time-changed': '_timeChanged'
			},

			behaviors: [
				window.D2L.PolymerBehaviors.DateTimePicker.LocalizeBehavior
			],

			properties: {
				_parser: {
					type: Object,
					readOnly: true,
					value: new d2lIntl.DateTimeParse(null, {locale:{date:{formats:{dateFormats:{short:'yyyy-MM-dd'}}}}})
				},
				_formatter: {
					type: Object,
					readOnly: true,
					value: new d2lIntl.DateTimeFormat(null, {locale:{date:{formats:{dateFormats:{short:'yyyy-MM-dd'}}}}})
				},
				hours: {
					type: Number,
					notify: true
				},
				minutes: {
					type: Number,
					notify: true
				},
				locale: String,
				overrides: Object,
				timezone: String,
				_dateValue: String,
				date: {
					type: String,
					notify: true,
					value: ''
				},
				time: {
					type: Object,
					notify: true,
					value: {
						hours: 0,
						minutes: 0
					}
				},
				datetime: {
					type: Object,
					notify: true,
					observer: '_dateTimeChanged'
				},
				boundary: Object,
				dateLabel: {
					type: String,
					value: ''
				},
				_dateLabel: {
					type: String,
					computed: '_computeDateLabel(dateLabel, localize)'
				},
				timeLabel: {
					type: String,
					value: ''
				},
				_timeLabel: {
					type: String,
					computed: '_computeTimeLabel(timeLabel, localize)'
				}
			},

			observers: [
				'_dateAndTimeChanged(date, time)'
			],

			_dateChanged: function(e) {
				this.date = e.detail.detail.value;
			},

			_timeChanged: function(e) {
				this.time = e.detail;
			},

			_dateTimeChanged: function(datetime) {
				if (typeof datetime === 'string') {
					try {
						datetime = new Date(datetime);
					} catch (e) {
						return;
					}
				}
				this._dontUpdateDateTime = true;
				this._dateValue = this._formatter.formatDate(datetime);
				this.hours = datetime.getHours();
				this.minutes = datetime.getMinutes();
				this._dontUpdateDateTime = false;
				this.fire('d2l-datetime-picker-datetime-changed', datetime);
			},

			_dateAndTimeChanged: function(date, time) {
				if (!this._parser || !date || !time || this._dontUpdateDateTime) {
					return;
				}
				var datetime = this._parser.parseDate(date);
				datetime.setHours(time.hours);
				datetime.setMinutes(time.minutes);
				this.datetime = datetime;
			},

			_computeDateLabel: function(dateLabel, localize) {
				return dateLabel ? dateLabel : localize('datepicker');
			},

			_computeTimeLabel: function(timeLabel, localize) {
				return timeLabel ? timeLabel : localize('timepicker');
			}
		});
	</script>
</dom-module>
