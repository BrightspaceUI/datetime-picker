<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../vaadin-date-picker/vaadin-date-picker-light.html">
<link rel="import" href="../iron-input/iron-input.html">
<link rel="import" href="../d2l-time-picker/d2l-time-picker.html">
<link rel="import" href="../d2l-offscreen/d2l-offscreen.html">
<link rel="import" href="../d2l-icons/d2l-icon-button.html">
<link rel="import" href="../d2l-icons/tier1-icons.html">
<link rel="import" href="localize-behavior.html">
<script type="text/javascript" src="https://s.brightspace.com/lib/d2l-intl/0.2.1/Intl.js"></script>
<script type="text/javascript" src="https://s.brightspace.com/lib/moment.js/2.15.2/moment.min.js"></script>
<script type="text/javascript" src="https://s.brightspace.com/lib/moment-timezone/0.5.10/moment-timezone-with-data.min.js"></script>

<!--
`d2l-time-picker`
Accessible, Localized Time Picker Input Element

@demo demo/index.html
-->

<dom-module id="d2l-datetime-picker">
	<template strip-whitespace>
		<style include="d2l-offscreen-shared-styles d2l-input-styles">
			:host {
				display: inline-flex;
				align-items: flex-start;
			}

			label {
				@apply --d2l-offscreen;
			}

			vaadin-date-picker-light {
				--primary-color: var(--d2l-color-celestine);
				--light-primary-color: var(--d2l-color-celestine-plus-1);
				--dark-theme-background-color: var(--d2l-color-ferrite);
				--dark-theme-secondary-color: var(--d2l-color-white);
				--primary-text-color: var(--d2l-color-ferrite);
				--secondary-text-color: var(--d2l-color-tungsten);
				--vaadin-date-picker-overlay: {
					font-family: inherit;
					max-height: 300px;
				};
				--vaadin-date-picker-yearscroller: {
					font-family: inherit;
				};
				--vaadin-date-picker-header: {
					font-family: inherit;
				};
				--vaadin-date-picker-calendar-title: {
					font-family: inherit;
				};
				--vaadin-date-picker-calendar-cell: {
					font-family: inherit;
				};
				--vaadin-date-picker-footer: {
					font-family: inherit;
				};
				--vaadin-date-picker-calendar: {
					font-family: inherit;
				};
			}

			vaadin-date-picker-light .d2l-input {
				width: 7rem;
			}

			.clear-button,
			.clear-button button {
				--d2l-icon-button-icon: {
					color: var(--d2l-color-tungsten);
				};
			}

			.clear-button button {
				height: 2.4rem;
			}

			d2l-time-picker {
				padding-left: 1rem;
				padding-right: 0.5rem;
			}

			:host-context([dir="rtl"]) d2l-time-picker {
				padding-left: 0.5rem;
				padding-right: 1rem;
			}

		</style>
		<label for="input">{{_dateLabel}}</label>
		<vaadin-date-picker-light value="{{date}}">
			<iron-input>
				<input aria-label$="{{_dateLabel}}" class="d2l-input" is="iron-input" type="text"/>
			</iron-input>
		</vaadin-date-picker-light>

		<template is="dom-if" if="{{date}}">
			<d2l-time-picker
				label="[[_timeLabel]]"
				locale="[[locale]]"
				overrides="[[overrides]]"
				timezone="[[timezone]]"
				hours="{{hours}}"
				minutes="{{minutes}}"
				boundary="[[boundary]]"
			></d2l-time-picker>
			<d2l-icon-button class="clear-button" icon="d2l-tier1:close-small">
				<button is="d2l-icon-button"
					icon="d2l-tier1:close-small"
					on-click="clear"
					title="[[localize('clear')]]"
					aria-label$="[[localize('clear')]]"
				></button>
			</d2l-icon-button>
		</template>
	</template>

	<script>
		Polymer({
			is: 'd2l-datetime-picker',

			behaviors: [
				window.D2L.PolymerBehaviors.DateTimePicker.LocalizeBehavior
			],

			properties: {
				_parser: {
					type: Object,
					readOnly: true,
					value: new d2lIntl.DateTimeParse(null, {locale:{date:{formats:{dateFormats:{short:'yyyy-MM-dd'}}}}})
				},
				hours: {
					type: Number,
					notify: true
				},
				minutes: {
					type: Number,
					notify: true
				},
				locale: String,
				overrides: Object,
				timezone: {
					type: String,
					value: moment.tz.guess(),
					notify: true
				},
				date: {
					type: String,
					notify: true,
					value: ''
				},
				datetime: {
					type: Object,
					notify: true,
					observer: '_dateTimeChanged'
				},
				boundary: Object,
				dateLabel: {
					type: String,
					value: ''
				},
				_dateLabel: {
					type: String,
					computed: '_computeDateLabel(dateLabel, localize)'
				},
				timeLabel: {
					type: String,
					value: ''
				},
				_timeLabel: {
					type: String,
					computed: '_computeTimeLabel(timeLabel, localize)'
				}
			},

			observers: [
				'_dateAndTimeChanged(date, timezone, hours, minutes)'
			],

			clear: function() {
				this.datetime = '';
			},

			_dateTimeChanged: function(datetime) {
				if (!datetime) {
					this.date = '';
					return;
				}
				datetime = moment.tz(datetime, this.timezone);
				if (!datetime.isValid()) {
					return;
				}
				this._dontUpdateDateTime = true;
				this.date = datetime.format('YYYY-MM-DD');
				this.hours = datetime.hours();
				this.minutes = datetime.minutes();
				this._dontUpdateDateTime = false;
				this.fire('d2l-datetime-picker-datetime-changed', datetime);
			},

			_dateAndTimeChanged: function() {
				if (!this._parser || this._dontUpdateDateTime) {
					return;
				}
				if (!this.date) {
					this.datetime = '';
					return;
				}
				var datetime;
				try {
					datetime = moment.tz(this.date, this.timezone);
					if (!datetime.isValid()) {
						return;
					}
				} catch (e) {
					return;
				}
				datetime.hours(this.hours);
				datetime.minutes(this.minutes);
				this.datetime = datetime;
			},

			_computeDateLabel: function(dateLabel, localize) {
				return dateLabel ? dateLabel : localize('datepicker');
			},

			_computeTimeLabel: function(timeLabel, localize) {
				return timeLabel ? timeLabel : localize('timepicker');
			}
		});
	</script>
</dom-module>
